"use strict";var Grafika=function(){function a(a){if(a&&!D.isPlaying()&&(navigator.userAgent.match(/Android/i)&&a.preventDefault(),("mousedown"!==a.type||1==a.which)&&!D.isPlaying())){var b=a.offsetX,c=a.offsetY;if(a.changedTouches&&(b=a.changedTouches[0].pageX,c=a.changedTouches[0].pageY),v.drawingMode==m&&x.length>0)return void(y=!0);if(v.drawingMode==n){var d=D.findSelectedGraphics(b,c);if(d.length>0)return x=[],e(),x=d,void e();x=[],e()}v.drawingMode==l&&(q.isPainting=v.drawingMode==l,u=C.createGraphic(v.graphic),u.isFilled=v.graphicFill,u.x=b,u.y=c,u.brushSize=v.brushSize,u.backgroundColor=v.backgroundColor,u.foregroundColor=v.foregroundColor,u.invoke(r,"mousedown",b,c))}}function b(a){if(a&&!D.isPlaying()){var b=a.offsetX,c=a.offsetY;if(!b||!c){if(!a.changedTouches)return;b=a.changedTouches[0].pageX,c=a.changedTouches[0].pageY}if(y&&x.length>0){s||(s=b),t||(t=c);for(var f=0;f<x.length;f++)x[f].move(r,b,c,s,t);return s=b,t=c,d(),void e()}q.isPainting&&u&&(u.invoke(r,"mousemove",b,c),e())}}function c(a){if(a&&!D.isPlaying()){var b=a.offsetX,c=a.offsetY;if(!b||!c){if(!a.changedTouches)return;b=a.changedTouches[0].pageX,c=a.changedTouches[0].pageY}return D.isPlaying()&&"mouseup"==a.type?void pause():y?(y=!1,A.on("frameUpdated",p.index),s=null,t=null,d(),void e()):void(q.isPainting&&(u.invoke(r,"mouseup",b,c),u&&u.isValid()&&(p.currentLayer().graphics.push(u),p.modified=!0,A.on("frameUpdated",p.index)),D.refresh(),q.isPainting=!1))}}function d(){r.clearRect(0,0,r.canvas.width,r.canvas.height),r.rect(-2,-2,q.getAttribute("width")+2,q.getAttribute("height")+2),r.fillStyle="#ffffff",r.fill()}function e(){return g(p)}function f(a,b){0>=a&&(a=0),b&&D.saveFrame(),w.currentFrame=a,p=w.frames[w.currentFrame],p||(p=new Grafika.Frame(D)),b&&D.saveFrame(),g(p,!0),A.on("frameChanged",p.index),i("Current Frame: "+(w.currentFrame+1)+"/"+w.frames.length,p)}function g(a,b){if(a)if(!b&&a&&a._id==p._id||(d(),x=[],p=a),r.rect(-2,-2,q.getAttribute("width")+2,q.getAttribute("height")+2),r.fillStyle=p.backgroundColor,r.fill(),v.useNavigationText&&(r.fillStyle="gray",r.font="25px Verdana",r.fontWeight="bold",r.fillText(w.currentFrame+1+" / "+w.frames.length,15,40)),p.backgroundResourceId){var c=new Image;c.onload=function(){r.drawImage(c,0,0,q.getAttribute("width"),q.getAttribute("height")),a.draw(r)},c.onerror=function(b){a.draw(r)},c.crossOrigin="use-credentials",!c.src}else a.draw(r)}function h(d){if(!d)throw new Error("canvasId is required");if(q=document.querySelector(d)||document.getElementById(d),!q)throw new Error("No element found for "+d+".");return q.isPainting=!1,q.addEventListener("mousedown",a),q.addEventListener("touchstart",a),q.addEventListener("mousemove",b),q.addEventListener("touchmove",b),q.addEventListener("mouseup",c),q.addEventListener("touchend",c),q.addEventListener("mouseleave",c),q.addEventListener("touchleave",c),r=q.getContext("2d"),r.setLineDash||(i("LineDash: is not available!"),r.setLineDash=function(){}),q}function i(){if(v.debugMode&&0!=arguments.length){for(var a=[],b=1;b<arguments.length;b++)a.push(arguments[b]);0==a.length&&(a="")}}var j="0.10.0",k="none",l="paint",m="move",n="select",o="delete";this.version=j;var p,q,r,s,t,u,v={backgroundColor:"#ffffff",foregroundColor:"#000000",brushSize:2,graphic:"freeform",graphicFill:!1,useCarbonCopy:!0,useNavigationText:!0,debugMode:!0,drawingMode:"none",loop:!1},w={},x=[],y=!1,z=null,A={on:function(a,b){i("[callback] "+a,b)}},B=[],C=new Grafika.Graphics.Factory,D=this;this.initialize=function(a,b,c){q=h(a),this.setAnimation(c),this.setOptions(b),Grafika.Plugins&&Grafika.Plugins.forEach(function(a){var b=a(D);i("Plugin: "+b.name+" v."+(b.version||"{unknown}")),B.push(b)}),i("Grafika v."+this.version+" [initialized]",this),A.on("initialized")},this.getAnimation=function(){return w},this.setAnimation=function(a){w=new Grafika.Animation(this,a),i("Animation ("+w._id+") name: "+w.name+", timer: "+w.timer+", size: "+w.width+" x "+w.height+", frames: "+w.frames.length+" frames"),q.setAttribute("width",w.width),q.setAttribute("height",w.height),this.setFrames(w.frames)},this.saveAnimation=function(){w.totalFrame=w.frames.length,w.modified=!1,w.modifiedDate=new Date,w.client={navigator:navigator},A.on("animationSaved")},this.play=function(){function a(){if(w.currentFrame>=w.frames.length-1){if(!v.loop)return D.pause();w.currentFrame=0}else f(w.currentFrame+1,!1)}z||(w.timer||(w.timer=500),i("Animation started. Timer: "+w.timer+"ms",w),z=window.setInterval(a,w.timer),A.on("playing",!0),this.navigateToFrame(0,!0))},this.pause=function(){"undefined"!=typeof z&&(window.clearInterval(z),z=null,A.on("playing",!1),i("Animation stopped"))},this.isPlaying=function(){return null!=z},this.isModified=function(){return w.modified?!0:!!p.modified},this.save=function(){this.saveAnimation(),this.saveFrame()},this.getFrame=function(){return p},this.getFrames=function(){return w.frames},this.setFrames=function(a){w.setFrames(a),p=w.frames[0],this.navigateToFrame(0),A.on("frameCount",w.totalFrame)},this.saveFrame=function(){p.modified=!1,w.frames[w.currentFrame]=p,A.on("frameSaved",w.currentFrame)},this.nextFrame=function(){this.navigateToFrame(w.currentFrame+1,!0)},this.previousFrame=function(){this.navigateToFrame(w.currentFrame-1,!0)},this.navigateToFrame=function(a){f(a,!0)},this.findSelectedGraphics=function(a,b){x=[];for(var c=0;c<p.layers.length;c++)for(var d=p.layers[c],e=0;e<d.graphics.length;e++){var f=d.graphics[e];if(f.contains(a,b))return x.push(f),x}return x},this.getSelectedGraphics=function(){return x},this.deleteSelectedGraphics=function(){p.modified=!0;for(var a=[],b=p.currentLayer().graphics,c=0;c<b.length;c++){for(var d=!1,e=0;e<x.length&&(b[c].id!=x[e].id||!(d=!0));e++);d||a.push(b[c])}b=a,x=[],this.refresh()},this.currentGraphic=function(){return u},this.setCallback=function(a){if(!a)throw new Error("callback cannot be undefined");A=a},this.setOptions=function(a){if(a){if(a.backgroundColor&&(v.backgroundColor=a.backgroundColor,p.backgroundColor=v.backgroundColor,this.refresh()),a.foregroundColor&&(v.foregroundColor=a.foregroundColor,p.foregroundColor=v.foregroundColor,this.refresh()),a.brushSize&&(v.brushSize=a.brushSize),a.graphic){var b=C.createGraphic(a.graphic);b&&(v.graphic=b.type),this.refresh()}if("undefined"!=typeof a.graphicFill&&null!=a.graphicFill&&(v.graphicFill=a.graphicFill,this.refresh()),"undefined"!=typeof a.useCarbonCopy&&null!=a.useCarbonCopy&&(v.useCarbonCopy=a.useCarbonCopy,this.refresh()),"undefined"!=typeof a.useNavigationText&&null!=a.useNavigationText&&(v.useNavigationText=a.useNavigationText,this.refresh()),"undefined"!=typeof a.loop&&null!=a.loop&&(v.loop=a.loop),a.drawingMode){var c=a.drawingMode.toLowerCase();if(c!=k&&c!=l&&c!=m&&c!=n&&c!=o)throw new Error("Drawing mode is not supported: "+c);v.drawingMode=c,v.drawingMode!=l&&v.drawingMode!=k||this.refresh(),v.drawingMode==o&&(this.deleteSelectedGraphics(),this.refresh())}"undefined"!=typeof a.debugMode&&null!=a.debugMode&&(v.debugMode=a.debugMode),i("Options: ",v)}},this.getOptions=function(){return v},this.getGraphicsFactory=function(){return C},this.getCanvas=function(){return q},this.refresh=function(){return u=null,g(p,!0)},this.clear=function(){p=new Grafika.Frame(D),this.refresh()}};Grafika.Plugins=[],Grafika.Graphics={},Grafika.Drawable=function(a){if(!a)throw new Error("grafika instance is required");this.randomUid=function(){return("000000"+(Math.random()*Math.pow(36,6)<<0).toString(36)).slice(-6)}},Grafika.Animation=function(a,b){function c(b){if(b){if(!b._id)throw new Error("Animation _id is required");if(!b.name)throw new Error("Animation name is required");if(!b.width||!b.height)throw new Error("Animation width + height is required");"undefined"!=typeof b.frames&&0!=b.frames.length||(b.frames=[new Grafika.Frame(a)])}else b={};return b}Grafika.Drawable.call(this,a),b=c(b),this.setFrames=function(b){b&&0!=b.length||(b=[new Grafika.Frame(a)]),this.frames=[];for(var c=0;c<b.length;c++)this.frames[c]=new Grafika.Frame(a,b[c]);return this.totalFrame=this.frames.length,this.frames},this._id=b._id||this.randomUid(),this.localId=b.localId||this.randomUid(),this.name=b.name||this._id,this.width=b.width||window.innerWidth,this.height=b.height||window.innerHeight,this.currentFrame=b.currentFrame||0,this.timer=b.timer||500,this.modified=b.modified||!1,this.totalFrame=b.totalFrame||0,this.views=b.views||0,this.dateCreated=b.dateCreated||new Date,this.dateModified=b.dateModified||this.dateCreated,this.frames=this.setFrames(b.frames)},Grafika.Frame=function(a,b){Grafika.Drawable.call(this,a),b||(b={}),this.setLayers=function(b){b&&0!=b.length||(b=[new Grafika.Layer(a)]),this.layers=[];for(var c=0;c<b.length;c++)this.layers[c]=new Grafika.Layer(a,b[c]);return this.layers},this.currentLayer=function(){return this.layers[this.layers.length-1]},this.draw=function(b){for(var c=a.getSelectedGraphics(),d=a.getAnimation(),e=a.getOptions(),f=a.currentGraphic(),g=0;g<c.length;g++){var h=c[g],i=h.getBounds(),j=h.brushSize/2;b.lineWidth=2,b.setLineDash([2,4]),"#000000"!=this.backgroundColor?b.strokeStyle="rgba(0, 0, 0, 0.5)":b.strokeStyle="rgba(255, 255, 255, 0.6)",b.strokeRect(i.x-j-2,i.y-j-2,i.width+2*j+4,i.height+2*j+4)}if(e.useCarbonCopy&&d.currentFrame>0){var k=d.frames[d.currentFrame-1];if(k)for(var l=0;l<k.layers.length;l++)k.layers[l].draw(b,!0)}for(var g=0;g<this.layers.length;g++)this.layers[g].draw(b);f&&f.draw(b)},this.id=b.id||this.randomUid(),this.index=b.index>=0?b.index:a.getAnimation().currentFrame||0,this.backgroundColor=b.backgroundColor||a.getOptions().backgroundColor,this.foregroundColor=b.foregroundColor||a.getOptions().foregroundColor,this.layers=this.setLayers(b.layers)},Grafika.Layer=function(a,b){function c(a){var b=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;a=a.replace(b,function(a,b,c,d){return b+b+c+c+d+d});var c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return c?{r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)}:{r:0,g:0,b:0}}Grafika.Drawable.call(this,a),b||(b={}),this.setGraphics=function(b){b&&0!=b.length||(b=[]),this.graphics=[];for(var c=0;c<b.length;c++)this.graphics[c]=a.getGraphicsFactory().createGraphic(b[c]);return this.graphics},this.draw=function(a,b){var d;a.setLineDash([]),a.lineJoin="round",a.lineCap="round";for(var e=0;e<this.graphics.length;e++){if(d=this.graphics[e],b){var f=c(d.foregroundColor);d.foregroundAlpha="rgba("+f.r+","+f.g+","+f.b+", 0.2)"}d.draw(a),delete d.foregroundAlpha}},this.id=b.id||this.randomUid(),this.index=b.index||0,this.graphics=this.setGraphics(b.graphics)},Grafika.Graphics.Shape=function(a){if(!a)throw new Error("invalid type");if(a&&!a.type)throw new Error("invalid type");this.id=a.id||("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4),this.x=a.x||0,this.y=a.y||0,this.width=a.width||0,this.height=a.height||0,this.backgroundColor=a.backgroundColor||"#ffffff",this.foregroundColor=a.foregroundColor||"#000000",this.isFilled=a.isFilled||!1,this.type=a.type,this.brushSize=a.brushSize||2,this.isVisible="undefined"!=typeof a.isVisible&&null!=a.isVisible?a.isVisible:!0,this.getBounds=function(){return{x:this.width>0?this.x:this.x+this.width,y:this.height>0?this.y:this.y+this.height,width:Math.abs(this.width),height:Math.abs(this.height)}},this.contains=function(a,b){var c=this.getBounds();return c.x<a&&c.x+c.width>a&&c.y<b&&c.y+c.height>b},this.isValid=function(){return Math.abs(this.width)>20&&Math.abs(this.height)>20},this.draw=function(a){a.lineWidth=this.brushSize>1?this.brushSize:1,a.strokeStyle=this.foregroundAlpha||this.foregroundColor,a.fillStyle=this.foregroundAlpha||this.foregroundColor,this.onDraw(a)},this.move=function(a,b,c,d,e){this.onMove(a,b,c,d,e)},this.invoke=function(a,b,c,d){this.onEvent(a,b,c,d)},this.onDraw=function(a){throw new Error("Not implemented onDraw()")},this.onMove=function(a,b,c,d,e){throw new Error("Not implemented onMove()")},this.onEvent=function(a,b,c,d){throw new Error("Not implemented onEvent()")}},Grafika.Graphics.Freeform=function(a){a=a||{type:"freeform"},Grafika.Graphics.Shape.call(this,a),this.points=a.points||[],this.getBounds=function(){for(var a={x:this.x,y:this.y,width:this.x,height:this.y},b=0;b<this.points.length;b++){var c=this.points[b];a.x>c.x&&(a.x=c.x),a.y>c.y&&(a.y=c.y),a.width<c.x&&(a.width=c.x),a.height<c.y&&(a.height=c.y)}return a.width=a.width-a.x,a.height=a.height-a.y,a},this.isValid=function(){var a=this.getBounds();return a.width>5||a.height>5},this.onDraw=function(a){a.beginPath(),a.moveTo(this.x,this.y);for(var b=0;b<this.points.length;b++){var c=this.points[b];a.lineTo(c.x,c.y)}this.isFilled?a.fill():a.stroke()},this.onMove=function(a,b,c,d,e){var f=this.x,g=this.y;this.x=this.x+(b-d),this.y=this.y+(c-e);for(var h=f-this.x,i=g-this.y,j=0;j<this.points.length;j++)this.points[j].x-=h,this.points[j].y-=i},this.onEvent=function(a,b,c,d){switch(b){case"mousemove":this.points.push({x:c,y:d})}}},Grafika.Graphics.Line=function(a){a=a||{type:"line"},Grafika.Graphics.Shape.call(this,a),this.endX=a.endX||0,this.endY=a.endY||0,this.getBounds=function(){return{x:this.x<this.endX?this.x:this.endX,y:this.y<this.endY?this.y:this.endY,width:this.x>this.endX?this.x-this.endX:this.endX-this.x,height:this.y>this.endY?this.y-this.endY:this.endY-this.y}},this.isValid=function(){return Math.abs(this.endX-this.x)>20||Math.abs(this.endY-this.y)>20},this.onDraw=function(a){a.moveTo(this.x,this.y),a.lineTo(this.endX,this.endY),a.stroke()},this.onMove=function(a,b,c,d,e){this.x=this.x+(b-d),this.y=this.y+(c-e),this.endX=this.endX+(b-d),this.endY=this.endY+(c-e)},this.onEvent=function(a,b,c,d){switch(b){case"mousemove":this.endX=c,this.endY=d}}},Grafika.Graphics.Rectangle=function(a){a=a||{type:"rectangle"},Grafika.Graphics.Shape.call(this,a),this.width=a.width||10,this.height=a.height||this.width,this.onDraw=function(a){this.isFilled?a.fillRect(this.x,this.y,this.width,this.height):a.strokeRect(this.x,this.y,this.width,this.height)},this.onMove=function(a,b,c,d,e){this.x=this.x+(b-d),this.y=this.y+(c-e)},this.onEvent=function(a,b,c,d){switch(b){case"mousemove":this.width=c-this.x,this.height=d-this.y}}},Grafika.Graphics.Square=function(a){a=a||{type:"square"},Grafika.Graphics.Rectangle.call(this,a),this.onEvent=function(a,b,c,d){switch(b){case"mousemove":this.width=c-this.x,this.height=d-this.y,this.width=this.width>this.height?this.height:this.width,this.height=this.width>this.height?this.height:this.width}}},Grafika.Graphics.Circle=function(a){a=a||{type:"circle"},Grafika.Graphics.Rectangle.call(this,a),this.radius=a.radius||5,this.getBounds=function(){return{x:this.x-this.radius,y:this.y-this.radius,width:2*this.radius,height:2*this.radius}},this.isValid=function(){return this.radius>5},this.onDraw=function(a){a.beginPath(),a.arc(this.x,this.y,this.radius,0,2*Math.PI),this.isFilled?a.fill():a.stroke()},this.onEvent=function(a,b,c,d){switch(b){case"mousemove":this.radius=Math.abs(c-this.x)}}},Grafika.Graphics.Oval=function(a){a=a||{type:"oval"},Grafika.Graphics.Circle.call(this,a),this.radiusY=a.radiusY||10,this.getBounds=function(){return{x:this.x-this.radius,y:this.y-this.radiusY,width:2*this.radius,height:2*this.radiusY}},this.isValid=function(){return this.radius>10&&this.radiusY>10},this.onDraw=function(a){a.beginPath(),a.ellipse(this.x,this.y,this.radius,this.radiusY,0,0,2*Math.PI),this.isFilled?a.fill():a.stroke()},this.onEvent=function(a,b,c,d){switch(b){case"mousemove":this.radius=Math.abs(c-this.x),this.radiusY=Math.abs(d-this.y)}}},Grafika.Graphics.Text=function(a){a=a||{type:"text"},"undefined"==typeof a.isFilled&&(a.isFilled=!0),Grafika.Graphics.Rectangle.call(this,a),this.text=a.text||"",this.font=a.font||"verdana",this.fontWeight=a.fontWeight||"normal",this.height=a.height||25,this.isValid=function(){return this.text&&this.text.length>0},this.onDraw=function(a){a.font=this.height+"px "+this.font,this.isFilled?(a.fillStyle=this.foregroundAlpha||this.foregroundColor,a.fillText(this.text,this.x,this.y+this.height)):(a.strokeStyle=this.foregroundAlpha||this.foregroundColor,a.strokeText(this.text,this.x,this.y+this.height))},this.onEvent=function(a,b,c,d){switch(b){case"mouseup":this.text=this.prompt("Insert text"),this.drawFocusRectangle(a),this.draw(a)}},this.drawFocusRectangle=function(a){var b=a.measureText(this.text);this.width=b.width,a.lineWidth=1,a.setLineDash([2,4]),a.strokeStyle=this.foregroundColor,a.rect(this.x,this.y,this.width,this.height)},this.prompt=function(a,b){return prompt(a,b)}},Grafika.Graphics.Triangle=function(a){a=a||{type:"triangle"},Grafika.Graphics.Rectangle.call(this,a),this.onDraw=function(a){a.beginPath(),a.moveTo(this.x+this.width/2,this.y),a.lineTo(this.x,this.y+this.height),a.lineTo(this.x+this.width,this.y+this.height),a.closePath(),this.isFilled?a.fill():a.stroke()}},Grafika.Graphics.Factory=function(){this.providers=[{type:"freeform",create:function(a){return new Grafika.Graphics.Freeform(a)}},{type:"line",create:function(a){return new Grafika.Graphics.Line(a)}},{type:"rectangle",create:function(a){return new Grafika.Graphics.Rectangle(a)}},{type:"square",create:function(a){return new Grafika.Graphics.Square(a)}},{type:"circle",create:function(a){return new Grafika.Graphics.Circle(a)}},{type:"oval",create:function(a){return new Grafika.Graphics.Oval(a)}},{type:"text",create:function(a){return new Grafika.Graphics.Text(a)}},{type:"triangle",create:function(a){return new Grafika.Graphics.Triangle(a)}}],this.createGraphic=function(a){if(!a)throw new Error("Graphic/type is required");var b={};if("string"==typeof a&&(b.type=a),"object"==typeof a&&(b=a),!b.type)throw new Error("Graphic/type is required (unspecified)");for(var c=0;c<this.providers.length;c++)if(this.providers[c].type.toLowerCase()===b.type.toLowerCase())return this.providers[c].create(b);throw new Error("Unsupported graphic: "+a)}};
//# sourceMappingURL=grafika.js.map